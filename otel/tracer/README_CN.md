<p>
    <a href="README.md">English</a>&nbsp ｜&nbsp 中文
</p>

# goner/otel/tracer

## 概述

`goner/otel/tracer` 是 Gone 框架中用于支持 OpenTelemetry 链路追踪功能的组件。该模块提供了与 OpenTelemetry
追踪系统的集成，使应用程序能够创建、记录和导出分布式追踪数据，帮助开发者理解请求在分布式系统中的流转路径和性能瓶颈。

## 主要功能

- 提供 OpenTelemetry 追踪系统的初始化和配置
- 支持创建和管理 Trace 和 Span
- 默认提供标准输出（stdout）的追踪数据导出器
- 与 Gone 框架的生命周期管理集成，确保应用关闭时正确刷新和关闭追踪系统
- 支持分布式上下文传播

## 子模块

- `goner/otel/tracer/http`: 提供基于 HTTP 协议的 OpenTelemetry 追踪数据导出器
- `goner/otel/tracer/grpc`: 提供基于 gRPC 协议的 OpenTelemetry 追踪数据导出器
- `goner/otel/tracer/zipkin`: 提供与 Zipkin 兼容的追踪数据导出器

## 安装方法

```bash
# 安装基础追踪模块
gonectl install goner/otel/tracer

# 安装 HTTP 导出器
gonectl install goner/otel/tracer/http

# 安装 gRPC 导出器
gonectl install goner/otel/tracer/grpc

# 安装 Zipkin 导出器
gonectl install goner/otel/tracer/zipkin
```

> 如果只安装`goner/otel/tracer`, 则默认使用标准输出（stdout）的追踪数据导出器；`goner/otel/tracer/http`、
`goner/otel/tracer/grpc`、`goner/otel/tracer/zipkin`只需要根据实际情况安装其中一个即可，并且已经依赖了`goner/otel/tracer`
> ，可以不用在手动安装`goner/otel/tracer`。

## 简单例子

> 展示通过`goner/otel/tracer`组件将追踪数据导出到标准输出（stdout）

### 执行下面命令

```bash
gonectl create -t otel/tracer/simple simple-demo
cd simple-demo
go run .
```

### 项目目录结构

```log
.
├── go.mod
├── go.sum
├── main.go 
├── module.load.go
└── your_compoent.go
```

### 代码

- [module.load.go](../../examples/otel/tracer/simple/module.load.go)，通过 运行`gonectl install goner/otel/tracer` 安装生成。

```go
// Code generated by gonectl. DO NOT EDIT.
package main

import (
	"github.com/gone-io/gone/v2"
	"github.com/gone-io/goner/g"
	"github.com/gone-io/goner/otel/tracer"
)

// load installed gone module LoadFunc
var loaders = []gone.LoadFunc{
	tracer.Register,
}

func GoneModuleLoad(loader gone.Loader) error {
	var ops []*g.LoadOp
	for _, f := range loaders {
		ops = append(ops, g.F(f))
	}
	return g.BuildOnceLoadFunc(ops...)(loader)
}
```

- [your_component.go](../../examples/otel/tracer/simple/your_component.go)，定义需要使用trace的 组件

```go
package main

import (
	"context"
	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/trace"
)

type YourComponent struct {
	gone.Flag
	tracer trace.Tracer `gone:"*,otel-tracer"` // 注入 OpenTelemetry Tracer
}

func (c *YourComponent) HandleRequest(ctx context.Context) {
	tracer := otel.Tracer("otel-tracer")

	// 创建新的 Span
	ctx, span := tracer.Start(ctx, "handle-request")
	// 确保在函数结束时结束 Span
	defer span.End()

	// 记录事件
	span.AddEvent("开始处理请求")

	// 处理业务逻辑...

	// 记录错误（如果有）
	// span.RecordError(err)
	// span.SetStatus(codes.Error, "处理请求失败")

	// 正常情况下设置状态为成功
	// span.SetStatus(codes.Ok, "")
}
```

- [main.go](../../examples/otel/tracer/simple/main.go)，函数入口

```go
package main

import (
	"context"
	"os"
)

func main() {
	//设置服务名称
	_ = os.Setenv("GONE_OTEL_SERVICE_NAME", "simple demo")

	gone.
		Loads(GoneModuleLoad).
		Load(&YourComponent{}).
		Run(func(c *YourComponent) {
			// 调用组件中的方法
			c.HandleRequest(context.Background())
		})
}

```

### 运行结果

```json
{
  "Name": "handle-request",
  "SpanContext": {
    "TraceID": "07a6c8eb54d98cf8f522dddcfed8ee09",
    "SpanID": "747c9aa400991ef5",
    "TraceFlags": "01",
    "TraceState": "",
    "Remote": false
  },
  "Parent": {
    "TraceID": "00000000000000000000000000000000",
    "SpanID": "0000000000000000",
    "TraceFlags": "00",
    "TraceState": "",
    "Remote": false
  },
  "SpanKind": 1,
  "StartTime": "0001-01-01T00:00:00Z",
  "EndTime": "0001-01-01T00:00:00Z",
  "Attributes": null,
  "Events": [
    {
      "Name": "开始处理请求",
      "Attributes": null,
      "DroppedAttributeCount": 0,
      "Time": "0001-01-01T00:00:00Z"
    }
  ],
  "Links": null,
  "Status": {
    "Code": "Unset",
    "Description": ""
  },
  "DroppedAttributes": 0,
  "DroppedEvents": 0,
  "DroppedLinks": 0,
  "ChildSpanCount": 0,
  "Resource": [
    {
      "Key": "service.name",
      "Value": {
        "Type": "STRING",
        "Value": "simple demo"
      }
    },
    {
      "Key": "telemetry.sdk.language",
      "Value": {
        "Type": "STRING",
        "Value": "go"
      }
    },
    {
      "Key": "telemetry.sdk.name",
      "Value": {
        "Type": "STRING",
        "Value": "opentelemetry"
      }
    },
    {
      "Key": "telemetry.sdk.version",
      "Value": {
        "Type": "STRING",
        "Value": "1.35.0"
      }
    }
  ],
  "InstrumentationScope": {
    "Name": "otel-tracer",
    "Version": "",
    "SchemaURL": "",
    "Attributes": null
  },
  "InstrumentationLibrary": {
    "Name": "otel-tracer",
    "Version": "",
    "SchemaURL": "",
    "Attributes": null
  }
}
```

## 使用其他Exporter
- [使用OLTP/HTTP](../../examples/otel/tracer/http)
- [使用OLTP/gRPC](../../examples/otel/tracer/grpc)
- [使用Zipkin](../../examples/otel/tracer/zipkin)

## 高级配置

### 自定义导出器

如果需要自定义追踪数据导出器，可以实现 `trace.SpanExporter` 接口并注入到框架中：

```go
var _ trace.SpanExporter = (*CustomExporter)(nil)

type CustomExporter struct {
// 实现 trace.SpanExporter 接口
}

// 定义加载函数
func RegisterCustomExporter(loader gone.Loader) {
    return loader.Load(&CustomExporter{})
}

//....
// 在启动过程中加载
// gone.Loads(RegisterCustomExporter)
//...
```

### 在自定义组件中检查程序是否使用OpenTelemetry/Tracer，在没有使用的情况下降低处理
```go
type YourComponent struct {
    isOtelTracerLoaded g.IsOtelTracerLoaded `gone:"*"`
}

func(s*YourComponent)BusinessLogic(){
	if s.isOtelTracerLoaded{
		// 处理追踪逻辑
    } else{
	    // 降级处理，不使用追踪	
    }
}
```

## 最佳实践

1. **合理命名 Span**：使用有意义的名称，反映操作的本质。
2. **设置适当的属性**：添加有助于分析的属性，但避免过多无用信息。
3. **正确管理 Span 生命周期**：确保每个 Span 都被正确结束。
4. **传播上下文**：在分布式系统中正确传播追踪上下文。
5. **记录关键事件和错误**：在 Span 中记录重要事件和错误信息。

## 常见问题

### 追踪数据未正确导出

- 检查收集器地址和端口是否正确
- 确认网络连接是否正常
- 查看应用日志中是否有导出错误信息

### 追踪链路不完整

- 检查上下文传播是否正确
- 确保所有服务都配置了相同的传播器（Propagator）
- 验证 Span 是否正确创建和结束

### 性能问题

- 调整采样率(暂时未支持设置采样率)
- 优化批处理配置
- 减少不必要的属性和事件

## 参考资料

- [OpenTelemetry 官方文档](https://opentelemetry.io/docs/)
- [分布式追踪系统原理](https://opentelemetry.io/docs/concepts/signals/traces/)
- [Gone 框架文档](https://github.com/gone-io/gone)