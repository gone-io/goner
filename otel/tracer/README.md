<p>
    English&nbsp ｜&nbsp <a href="README_CN.md">中文</a>
</p>

# goner/otel/tracer

## Overview

`goner/otel/tracer` is a component in the Gone framework that supports OpenTelemetry distributed tracing functionality. This module provides integration with the OpenTelemetry tracing system, enabling applications to create, record, and export distributed tracing data, helping developers understand request flow paths and performance bottlenecks in distributed systems.

## Key Features

- Provides initialization and configuration of the OpenTelemetry tracing system
- Supports creation and management of Traces and Spans
- Offers a default standard output (stdout) trace data exporter
- Integrates with Gone framework's lifecycle management to ensure proper flushing and shutdown of the tracing system
- Supports distributed context propagation

## Submodules

- `goner/otel/tracer/http`: Provides HTTP protocol-based OpenTelemetry trace data exporter
- `goner/otel/tracer/grpc`: Provides gRPC protocol-based OpenTelemetry trace data exporter
- `goner/otel/tracer/zipkin`: Provides Zipkin-compatible trace data exporter

## Installation

```bash
# Install base tracing module
gonectl install goner/otel/tracer

# Install HTTP exporter
gonectl install goner/otel/tracer/http

# Install gRPC exporter
gonectl install goner/otel/tracer/grpc

# Install Zipkin exporter
gonectl install goner/otel/tracer/zipkin
```

> If you only install `goner/otel/tracer`, it will use the standard output (stdout) trace data exporter by default. For `goner/otel/tracer/http`, `goner/otel/tracer/grpc`, and `goner/otel/tracer/zipkin`, you only need to install one based on your specific needs, and since they already depend on `goner/otel/tracer`, you don't need to manually install `goner/otel/tracer`.

## Simple Example

> Demonstrates exporting trace data to standard output (stdout) using the `goner/otel/tracer` component

### Execute the following commands

```bash
gonectl create -t otel/tracer/simple simple-demo
cd simple-demo
go run .
```

### Project Directory Structure

```log
.
├── go.mod
├── go.sum
├── main.go 
├── module.load.go
└── your_compoent.go
```

### Code

- [module.load.go](../../examples/otel/tracer/simple/module.load.go), generated by running `gonectl install goner/otel/tracer`.

```go
// Code generated by gonectl. DO NOT EDIT.
package main

import (
	"github.com/gone-io/gone/v2"
	"github.com/gone-io/goner/g"
	"github.com/gone-io/goner/otel/tracer"
)

// load installed gone module LoadFunc
var loaders = []gone.LoadFunc{
	tracer.Register,
}

func GoneModuleLoad(loader gone.Loader) error {
	var ops []*g.LoadOp
	for _, f := range loaders {
		ops = append(ops, g.F(f))
	}
	return g.BuildOnceLoadFunc(ops...)(loader)
}
```

- [your_component.go](../../examples/otel/tracer/simple/your_component.go), defines the component that needs to use trace

```go
package main

import (
	"context"
	"go.opentelemetry.io/otel"
	"go.opentelemetry.io/otel/trace"
)

type YourComponent struct {
	gone.Flag
	tracer trace.Tracer `gone:"*,otel-tracer"` // Inject OpenTelemetry Tracer
}

func (c *YourComponent) HandleRequest(ctx context.Context) {
	tracer := otel.Tracer("otel-tracer")

	// Create new Span
	ctx, span := tracer.Start(ctx, "handle-request")
	// Ensure Span ends when function returns
	defer span.End()

	// Record event
	span.AddEvent("Start processing request")

	// Process business logic...

	// Record error (if any)
	// span.RecordError(err)
	// span.SetStatus(codes.Error, "Failed to process request")

	// Set status to OK in normal case
	// span.SetStatus(codes.Ok, "")
}
```

- [main.go](../../examples/otel/tracer/simple/main.go), program entry point

```go
package main

import (
	"context"
	"os"
)

func main() {
	//Set service name
	_ = os.Setenv("GONE_OTEL_SERVICE_NAME", "simple demo")

	gone.
		Loads(GoneModuleLoad).
		Load(&YourComponent{}).
		Run(func(c *YourComponent) {
			// Call component method
			c.HandleRequest(context.Background())
		})
}
```

### Run Result

```json
{
  "Name": "handle-request",
  "SpanContext": {
    "TraceID": "07a6c8eb54d98cf8f522dddcfed8ee09",
    "SpanID": "747c9aa400991ef5",
    "TraceFlags": "01",
    "TraceState": "",
    "Remote": false
  },
  "Parent": {
    "TraceID": "00000000000000000000000000000000",
    "SpanID": "0000000000000000",
    "TraceFlags": "00",
    "TraceState": "",
    "Remote": false
  },
  "SpanKind": 1,
  "StartTime": "0001-01-01T00:00:00Z",
  "EndTime": "0001-01-01T00:00:00Z",
  "Attributes": null,
  "Events": [
    {
      "Name": "Start processing request",
      "Attributes": null,
      "DroppedAttributeCount": 0,
      "Time": "0001-01-01T00:00:00Z"
    }
  ],
  "Links": null,
  "Status": {
    "Code": "Unset",
    "Description": ""
  },
  "DroppedAttributes": 0,
  "DroppedEvents": 0,
  "DroppedLinks": 0,
  "ChildSpanCount": 0,
  "Resource": [
    {
      "Key": "service.name",
      "Value": {
        "Type": "STRING",
        "Value": "simple demo"
      }
    },
    {
      "Key": "telemetry.sdk.language",
      "Value": {
        "Type": "STRING",
        "Value": "go"
      }
    },
    {
      "Key": "telemetry.sdk.name",
      "Value": {
        "Type": "STRING",
        "Value": "opentelemetry"
      }
    },
    {
      "Key": "telemetry.sdk.version",
      "Value": {
        "Type": "STRING",
        "Value": "1.35.0"
      }
    }
  ],
  "InstrumentationScope": {
    "Name": "otel-tracer",
    "Version": "",
    "SchemaURL": "",
    "Attributes": null
  },
  "InstrumentationLibrary": {
    "Name": "otel-tracer",
    "Version": "",
    "SchemaURL": "",
    "Attributes": null
  }
}
```

## Using Other Exporters
- [Using OLTP/HTTP](../../examples/otel/tracer/http)
- [Using OLTP/gRPC](../../examples/otel/tracer/grpc)
- [Using Zipkin](../../examples/otel/tracer/zipkin)

## Advanced Configuration

### Custom Exporter

If you need to customize the trace data exporter, you can implement the `trace.SpanExporter` interface and inject it into the framework:

```go
var _ trace.SpanExporter = (*CustomExporter)(nil)

type CustomExporter struct {
// Implement trace.SpanExporter interface
}

// Define load function
func RegisterCustomExporter(loader gone.Loader) {
    return loader.Load(&CustomExporter{})
}

//....
// Load during startup
// gone.Loads(RegisterCustomExporter)
//...
```

### Check OpenTelemetry/Tracer Usage in Custom Components and Degrade Processing When Not Used
```go
type YourComponent struct {
    isOtelTracerLoaded g.IsOtelTracerLoaded `gone:"*"`
}

func(s*YourComponent)BusinessLogic(){
	if s.isOtelTracerLoaded{
		// Handle tracing logic
    } else{
	    // Degraded processing, not using tracing	
    }
}
```

## Best Practices

1. **Appropriate Span Naming**: Use meaningful names that reflect the nature of the operation.
2. **Set Appropriate Attributes**: Add attributes that help with analysis, but avoid excessive unnecessary information.
3. **Proper Span Lifecycle Management**: Ensure each Span is properly ended.
4. **Context Propagation**: Correctly propagate context in distributed systems.
5. **Record Key Events and Errors**: Record important events and error information in Spans.

## Common Issues

### Trace Data Not Properly Exported

- Check if collector address and port are correct
- Verify network connectivity
- Check application logs for export error messages

### Incomplete Trace Chain

- Check if context propagation is correct
- Ensure all services are configured with the same propagator
- Verify if Spans are properly created and ended

### Performance Issues

- Adjust sampling rate (sampling rate setting not currently supported)
- Optimize batch processing configuration
- Reduce unnecessary attributes and events

## References

- [OpenTelemetry Documentation](https://opentelemetry.io/docs/)
- [Distributed Tracing System Principles](https://opentelemetry.io/docs/concepts/signals/traces/)
- [Gone Framework Documentation](https://github.com/gone-io/gone)