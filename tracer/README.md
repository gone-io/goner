<p>
    English&nbsp ｜&nbsp <a href="README_CN.md">中文</a>
</p>

# goner/tracer Component

## Component Features

The `goner/tracer` component provides a simple function: **automatically adding traceID to logs (requires cooperation with logging components, currently supports `goner/zap`), without manually passing context**.

It solves the following core problems:
- Implementing automatic log association with traceID in the Gone framework
- No need to explicitly pass `context.Context` in each function
- Supporting traceID propagation across goroutines

## Quick Start

### Installation

```bash
# Choose one implementation method to install
gonectl install goner/tracer/gls  # Complete functionality implementation
# or
gonectl install goner/tracer/gid  # High-performance implementation
```

### Basic Usage

```go
type MyService struct {
    gone.Flag
    tracer tracer.Tracer `gone:"*"`  // Inject tracer
    logger gone.Logger   `gone:"*"`  // Inject logger
}

func (s *MyService) DoSomething() {
    // Set trace ID
    s.tracer.SetTraceId("", func() {  // Empty string means auto-generate traceID
        // Logs will automatically include traceID
        s.logger.Info("Processing business logic...")

        // If you need to get the current traceID
        traceId := s.tracer.GetTraceId()
        s.logger.Infof("Current trace ID: %s", traceId)

        // Cross-goroutine traceID propagation - Important!
        s.tracer.Go(func() {
            // Logs here will also carry the same traceID
            s.logger.Info("Child goroutine processing...")
        })
    })
}
```

## Core API

```go
type Tracer interface {
    // Set traceID and execute callback function
    SetTraceId(traceId string, fn func())
    
    // Get the traceID of the current goroutine
    GetTraceId() string
    
    // Create a new goroutine while maintaining traceID (must use this instead of the go keyword)
    Go(fn func())
}
```

## Comparison of Two Implementation Methods

| Implementation Method         | Advantages     | Disadvantages | Applicable Scenarios |
| ----------------------------- | -------------- | ------------- | -------------------- |
| **gls implementation** (goner/tracer/gls) | No need to get gid | Lower performance | General scenarios |
| **gid implementation** (goner/tracer/gid) | High performance (about 10x) | None | High concurrency scenarios |


**Performance Test**

```log
➜  goner go test -bench=. -benchmem ./tracer
goos: darwin
goarch: arm64
pkg: github.com/gone-io/goner/tracer
cpu: Apple M1 Pro
BenchmarkTracer_SetTraceId-8             1479470               833.5 ns/op           976 B/op         11 allocs/op
BenchmarkTracerOverGid_SetTraceId-8     17734480                67.41 ns/op           64 B/op          2 allocs/op
BenchmarkTracer_GetTraceId-8             1533403               783.8 ns/op           128 B/op          1 allocs/op
BenchmarkTracerOverGid_GetTraceId-8     120586562                9.443 ns/op           0 B/op          0 allocs/op
BenchmarkTracer_Go-8                      365029              4421 ns/op             987 B/op         12 allocs/op
BenchmarkTracerOverGid_Go-8              1693129               709.2 ns/op           157 B/op          5 allocs/op
BenchmarkTracer_Concurrent-8               30535             39531 ns/op           12665 B/op        148 allocs/op
BenchmarkTracerOverGid_Concurrent-8       252675              4841 ns/op            1222 B/op         41 allocs/op
BenchmarkTracer_Nested-8                  120984              9931 ns/op            2592 B/op         28 allocs/op
BenchmarkTracerOverGid_Nested-8          5440866               221.3 ns/op           168 B/op          7 allocs/op
PASS
ok      github.com/gone-io/goner/tracer 17.094s
```

## Important Usage Notes

1. **Must use `tracer.Go()` instead of the standard `go` keyword**, otherwise the child goroutine will not be able to get the traceID

2. **Set traceID at entry points**: Use `SetTraceId` at entry points such as HTTP handlers

3. **Cross-service propagation**: If you need to propagate traceID across services, you need to manually add it to the request header:
   ```go
   // When sending a request
   req.Header.Set("X-Trace-ID", tracer.GetTraceId())
   
   // When receiving a request
   traceId := r.Header.Get("X-Trace-ID")
   tracer.SetTraceId(traceId, func() {
       // Process the request...
   })
   ```

4. **Integration with OpenTelemetry**: If `goner/otel/tracer` is installed, traceID will be generated by OpenTelemetry and automatically propagated across processes, but if you need complete OpenTelemetry functionality (metrics, etc.), you still need to explicitly pass `context.Context` according to the specification